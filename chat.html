<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>NT Chat</title>

<style>
:root {
  --bg:#0f172a;
  --panel:#020617;
  --me:#2563eb;
  --other:#1e293b;
  --text:#e5e7eb;
  --muted:#9ca3af;
}

*{box-sizing:border-box;font-family:system-ui}
body{
  margin:0;
  height:100dvh;
  display:flex;
  flex-direction:column;
  background:var(--bg);
  color:var(--text);
}

header{
  padding:12px;
  text-align:center;
  background:var(--panel);
  font-weight:600;
}

#messages{
  flex:1;
  overflow-y:auto;
  padding:12px;
  display:flex;
  flex-direction:column;
  gap:8px;
}

.msg{
  max-width:75%;
  padding:10px;
  border-radius:14px;
  animation:pop .2s ease;
  word-wrap:break-word;
}

.me{align-self:flex-end;background:var(--me)}
.other{align-self:flex-start;background:var(--other)}

.msg img{
  max-width:100%;
  border-radius:10px;
  cursor:pointer;
}

.time{
  font-size:10px;
  color:var(--muted);
  margin-top:4px;
  text-align:right;
}

@keyframes pop{
  from{transform:scale(.9);opacity:0}
  to{transform:scale(1);opacity:1}
}

#preview{
  display:none;
  padding:8px;
  background:#020617;
  border-top:1px solid #1e293b;
}

#preview img{
  max-height:120px;
  border-radius:8px;
}

#progress{
  height:4px;
  background:#1e293b;
  margin-top:6px;
  overflow:hidden;
}
#progress div{
  height:100%;
  width:0%;
  background:#22c55e;
}

footer{
  display:flex;
  gap:6px;
  padding:10px;
  background:var(--panel);
}

input[type=text]{
  flex:1;
  padding:10px;
  border-radius:12px;
  border:none;
  outline:none;
}

button{
  border:none;
  border-radius:12px;
  padding:0 14px;
  background:#22c55e;
  color:black;
  font-weight:600;
}

input[type=file]{display:none}

#viewer{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.9);
  display:none;
  justify-content:center;
  align-items:center;
}
#viewer img{
  max-width:95%;
  max-height:95%;
}
</style>
</head>

<body>
<header>NT Chat</header>

<div id="messages"></div>

<div id="preview">
  <img id="previewImg">
  <div id="progress"><div></div></div>
</div>

<footer>
  <label>
    ðŸ“·
    <input type="file" id="file" accept="image/*">
  </label>
  <input id="text" placeholder="Ketik pesanâ€¦">
  <button id="send">Send</button>
</footer>

<div id="viewer" onclick="this.style.display='none'">
  <img id="viewerImg">
</div>

<script>
/* ===== CONFIG ===== */
const topic = "ntchat-demo"; // ganti sesuai topic
const ntfy = "https://ntfy.sh/"+topic;

/* ===== ELEMENT ===== */
const msgBox = document.getElementById("messages");
const text = document.getElementById("text");
const sendBtn = document.getElementById("send");
const fileInput = document.getElementById("file");
const preview = document.getElementById("preview");
const previewImg = document.getElementById("previewImg");
const bar = document.querySelector("#progress div");

/* ===== HELPERS ===== */
function time(){
  return new Date().toLocaleTimeString("id-ID",{hour:"2-digit",minute:"2-digit"});
}

function bubble(html,me=true){
  const d=document.createElement("div");
  d.className="msg "+(me?"me":"other");
  d.innerHTML=html+`<div class="time">${time()}</div>`;
  msgBox.appendChild(d);
  msgBox.scrollTop=msgBox.scrollHeight;
}

function openViewer(src){
  viewerImg.src=src;
  viewer.style.display="flex";
}

/* ===== TEXT SEND ===== */
async function sendText(){
  if(!text.value.trim())return;
  bubble(text.value,true);
  await fetch(ntfy,{method:"POST",body:text.value});
  text.value="";
}

sendBtn.onclick=sendText;
text.onkeydown=e=>{if(e.key==="Enter")sendText();}

/* ===== IMAGE ===== */
fileInput.onchange=async()=>{
  const file=fileInput.files[0];
  if(!file)return;

  /* compress */
  const img=new Image();
  img.src=URL.createObjectURL(file);
  await img.decode();

  const canvas=document.createElement("canvas");
  const max=1280;
  let w=img.width,h=img.height;
  if(w>max){h=h*(max/w);w=max;}
  canvas.width=w;canvas.height=h;
  canvas.getContext("2d").drawImage(img,0,0,w,h);

  const blob=await new Promise(r=>canvas.toBlob(r,"image/jpeg",0.75));

  preview.style.display="block";
  previewImg.src=URL.createObjectURL(blob);
  bar.style.width="0%";

  /* upload via CORS-safe proxy */
  const fd=new FormData();
  fd.append("file",blob,"img.jpg");

  const xhr=new XMLHttpRequest();
  xhr.open("POST","https://api.allorigins.win/raw?url=https://0x0.st");
  xhr.upload.onprogress=e=>{
    if(e.lengthComputable){
      bar.style.width=(e.loaded/e.total*100)+"%";
    }
  };
  xhr.onload=async()=>{
    const url=xhr.responseText.trim();
    bubble(`<img src="${url}" onclick="openViewer('${url}')">`,true);
    await fetch(ntfy,{method:"POST",body:url});
    preview.style.display="none";
    fileInput.value="";
  };
  xhr.send(fd);
};

/* ===== RECEIVE ===== */
const es=new EventSource(ntfy+"/sse");
es.onmessage=e=>{
  if(!e.data)return;
  if(e.data.startsWith("http")){
    bubble(`<img src="${e.data}" onclick="openViewer('${e.data}')">`,false);
  }else{
    bubble(e.data,false);
  }
};
</script>
</body>
</html>
